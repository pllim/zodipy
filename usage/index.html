
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Zodiacal emission simulations with python">
      
      
      
      
        <link rel="prev" href="../install/">
      
      
        <link rel="next" href="../reference/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.1.21">
    
    
      
        <title>Usage - ZodiPy</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#timestreams" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ZodiPy" class="md-header__button md-logo" aria-label="ZodiPy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ZodiPy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Usage
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/cosmoglobe/zodipy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ZodiPy" class="md-nav__button md-logo" aria-label="ZodiPy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg>

    </a>
    ZodiPy
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cosmoglobe/zodipy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Install
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Usage
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#timestreams" class="md-nav__link">
    Timestreams
  </a>
  
    <nav class="md-nav" aria-label="Timestreams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#emission-along-a-meridian" class="md-nav__link">
    Emission along a meridian
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#healpix-maps" class="md-nav__link">
    HEALPix maps
  </a>
  
    <nav class="md-nav" aria-label="HEALPix maps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instantaneous-map-in-ecliptic-coordinates" class="md-nav__link">
    Instantaneous map in ecliptic coordinates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bandpass-integrated-emission" class="md-nav__link">
    Bandpass integrated emission
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solar-cutoff-angle" class="md-nav__link">
    Solar cutoff angle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-ecliptic-coordinates" class="md-nav__link">
    Non-ecliptic coordinates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#component-wise-maps" class="md-nav__link">
    Component-wise maps
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallelization" class="md-nav__link">
    Parallelization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualizing-the-interplanetary-dust-distribution-of-a-model" class="md-nav__link">
    Visualizing the interplanetary dust distribution of a model
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../reference/" class="md-nav__link">
        Reference
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#timestreams" class="md-nav__link">
    Timestreams
  </a>
  
    <nav class="md-nav" aria-label="Timestreams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#emission-along-a-meridian" class="md-nav__link">
    Emission along a meridian
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#healpix-maps" class="md-nav__link">
    HEALPix maps
  </a>
  
    <nav class="md-nav" aria-label="HEALPix maps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instantaneous-map-in-ecliptic-coordinates" class="md-nav__link">
    Instantaneous map in ecliptic coordinates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bandpass-integrated-emission" class="md-nav__link">
    Bandpass integrated emission
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solar-cutoff-angle" class="md-nav__link">
    Solar cutoff angle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-ecliptic-coordinates" class="md-nav__link">
    Non-ecliptic coordinates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#component-wise-maps" class="md-nav__link">
    Component-wise maps
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallelization" class="md-nav__link">
    Parallelization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualizing-the-interplanetary-dust-distribution-of-a-model" class="md-nav__link">
    Visualizing the interplanetary dust distribution of a model
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Usage</h1>

<h2 id="timestreams">Timestreams</h2>
<p>Below we illustrate how ZodiPy can be used to create timestreams of the zodiacal emission. 
Note that since ZodiPy assumes a constant observer position over the input pointing sequence, the output
will not be <em>real</em> timestreams, but for small enough time intervals the error is negligible.</p>
<h3 id="emission-along-a-meridian">Emission along a meridian</h3>
<p>In the following example we simulate what an observer on Earth is expected to see on 14 June, 
2022 when looking along a meridian (line of constant longitude) at 30 microns, given the 
DIRBE interplanetary dust model.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">Zodipy</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">(</span><span class="s2">&quot;dirbe&quot;</span><span class="p">)</span>

<span class="n">latitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">longitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)</span>

<span class="n">emission</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_emission_ang</span><span class="p">(</span>
    <span class="mi">30</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">longitudes</span><span class="p">,</span>
    <span class="n">phi</span><span class="o">=</span><span class="n">latitudes</span><span class="p">,</span>
    <span class="n">lonlat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2022-06-14&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">latitudes</span><span class="p">,</span> <span class="n">emission</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Latitude [deg]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Emission [MJy/sr]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../img/timestream.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="Zodiacal emission timestream" src="../img/timestream.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ZodiPy assumes a constant observer position over an input pointing sequence. For an observer on Earth, 
the true zodiacal emission signal will move along the ecliptic on the sky by roughly one degree each day. 
To account for this effect, the full pointing sequence of an experiment should be chunked into small 
subsequences with timescales corresponding to at maximum a day.</p>
</div>
<h2 id="healpix-maps">HEALPix maps</h2>
<p>Below we illustrate how ZodiPy can be used to create simulated binned HEALPix maps of the zodiacal emission.</p>
<h3 id="instantaneous-map-in-ecliptic-coordinates">Instantaneous map in ecliptic coordinates</h3>
<p>In the following example we make an instantaneous map of of the zodiacal emission at 857 GHz
as seen by an observer on earth on 14 June, 2022 given the Planck 2018 interplanetary dust model.</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">Zodipy</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">(</span><span class="s2">&quot;planck18&quot;</span><span class="p">)</span>
<span class="n">nside</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">binned_emission</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
    <span class="mi">857</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span>
    <span class="n">pixels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)),</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2022-06-14&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span>
    <span class="n">binned_emission</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Binned zodiacal emission at 857 GHz&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;MJy/sr&quot;</span><span class="p">,</span>
    <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;afmhot&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../img/binned.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<img alt="Zodiacal emission map" src="../img/binned.png" />
<em>Note that the color bar is logarithmic.</em></p>
<h3 id="bandpass-integrated-emission">Bandpass integrated emission</h3>
<p>Instruments do not typically observe at delta frequencies. Usually, we are more interested in finding out
what the emission looks like over some instrument bandpass. ZodiPy will accept a sequence of frequencies to the <code>freq</code>
argument in addition to the corresponding bandpass weights to the <code>weights</code> argument and perform bandpass integration. 
Note that the bandpass weights must be in spectral radiance units (Jy/sr), even though the weights them self are unitless. A top hat bandpass is assumed if a sequence of frequencies are used without providing weights.
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">Zodipy</span>

<span class="n">nside</span> <span class="o">=</span> <span class="mi">128</span>

<span class="hll"><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">800</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GHz</span>
</span><span class="hll"><span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">750</span><span class="p">,</span> <span class="mi">850</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GHz</span>
</span><span class="hll"><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mf">11.5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency [GHz]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weights&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../img/bandpass.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;planck18&quot;</span><span class="p">)</span>

<span class="n">emission_central_freq</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
    <span class="n">freq</span><span class="o">=</span><span class="n">center_freq</span><span class="p">,</span>
    <span class="n">pixels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)),</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2022-03-10&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="s2">&quot;SEMB-L2&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">emission_bandpass_integrated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
<span class="hll">    <span class="n">freq</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
</span><span class="hll">    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
</span>    <span class="n">pixels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)),</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2022-03-10&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="s2">&quot;SEMB-L2&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span>
    <span class="n">emission_central_freq</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Center frequency&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;MJy/sr&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;afmhot&quot;</span><span class="p">,</span>
    <span class="n">norm</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../img/center_freq.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span>
    <span class="n">emission_bandpass_integrated</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Bandpass integrated&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;MJy/sr&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;afmhot&quot;</span><span class="p">,</span>
    <span class="n">norm</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../img/bandpass_integrated.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<img alt="Generated Bandpass" src="../img/bandpass.png" />
<img alt="Center frequency emission" src="../img/center_freq.png" />
<img alt="Bandpass integrated emission" src="../img/bandpass_integrated.png" /></p>
<h3 id="solar-cutoff-angle">Solar cutoff angle</h3>
<p>Few experiments look directly in towards the Sun. We can initialize <code>Zodipy</code> with the <code>solar_cut</code> 
argument to mask all input pointing that looks in towards the sun with an angular distance smaller 
than the <code>solar_cut</code> value.</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">Zodipy</span>

<span class="hll"><span class="n">model</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">(</span><span class="s2">&quot;dirbe&quot;</span><span class="p">,</span> <span class="n">solar_cut</span><span class="o">=</span><span class="mi">60</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
</span><span class="n">nside</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">binned_emission</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
    <span class="mi">25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span>
    <span class="n">pixels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)),</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span>
    <span class="n">binned_emission</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Solar cutoff at 60 degrees&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;MJy/sr&quot;</span><span class="p">,</span>
    <span class="nb">max</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
    <span class="n">coord</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;afmhot&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../img/binned_solar_cutoff.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<img alt="Zodiacal emission map" src="../img/binned_solar_cutoff.png" /></p>
<h3 id="non-ecliptic-coordinates">Non-ecliptic coordinates</h3>
<p>We can specify the coordinate system of the input pointing with the <code>coord_in</code> keyword</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">Zodipy</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">(</span><span class="s2">&quot;planck18&quot;</span><span class="p">)</span>
<span class="n">nside</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">binned_emission</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
    <span class="mi">857</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">,</span>
    <span class="n">pixels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)),</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2022-02-20&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span>
<span class="hll">    <span class="n">coord_in</span><span class="o">=</span><span class="s2">&quot;G&quot;</span><span class="p">,</span>  <span class="c1"># Coordinates of the input pointing</span>
</span><span class="p">)</span>

<span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span>
    <span class="n">binned_emission</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Binned zodiacal emission at 857 GHz&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;MJy/sr&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;afmhot&quot;</span><span class="p">,</span>
    <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../img/binned_gal.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<img alt="Zodiacal emission map galactic" src="../img/binned_gal.png" /></p>
<h3 id="component-wise-maps">Component-wise maps</h3>
<p>ZodiPy can also return the zodiacal emission component-wise. In the following example we use
the DIRBE model since the later Planck models excluded the circumsolar-ring and Earth-trailing 
feature components. For more information on the interplanetary dust models, please 
read <a href="https://arxiv.org/abs/2205.12962">Cosmoglobe: Simulating Zodiacal Emission with ZodiPy</a>.</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">Zodipy</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">(</span><span class="s2">&quot;dirbe&quot;</span><span class="p">)</span>
<span class="n">nside</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">binned_emission</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
    <span class="mi">25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span>
    <span class="n">pixels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)),</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2022-01-01&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span>
<span class="hll">    <span class="n">return_comps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Cloud&quot;</span><span class="p">,</span> <span class="s2">&quot;Band1&quot;</span><span class="p">,</span> <span class="s2">&quot;Band2&quot;</span><span class="p">,</span> <span class="s2">&quot;Band3&quot;</span><span class="p">,</span> <span class="s2">&quot;Ring&quot;</span><span class="p">,</span> <span class="s2">&quot;Feature&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">binned_comp_emission</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">binned_emission</span><span class="p">):</span>
    <span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span>
        <span class="n">binned_comp_emission</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">comps</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
        <span class="n">norm</span><span class="o">=</span><span class="s2">&quot;log&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;afmhot&quot;</span><span class="p">,</span>
        <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sub</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
    <span class="p">)</span>
<span class="c1"># plt.savefig(&quot;../img/binned_comp.png&quot;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<img alt="Component-wise emission maps" src="../img/binned_comp.png" />
<em>Note that the color for the Cloud component is logarithmic, while the others are linear.</em></p>
<h2 id="parallelization">Parallelization</h2>
<p>If you are not using ZodiPy in an already parallelized environment, you may specify the number of cores used by ZodiPy through the <code>n_proc</code> keyword. By default <code>n_proc</code> is set to 1. For values of <code>n_proc</code> &gt; 1, the line-of-sight calculations are parallelized using the <code>multiprocessing</code> module.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">Zodipy</span>

<span class="n">nside</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">))</span>
<span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">)</span>
<span class="n">n_proc</span> <span class="o">=</span> <span class="mi">8</span>

<span class="hll"><span class="n">model</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">()</span>
</span><span class="hll"><span class="n">model_parallel</span> <span class="o">=</span> <span class="n">Zodipy</span><span class="p">(</span><span class="n">n_proc</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)</span>
</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">emission</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
    <span class="mi">40</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span>
    <span class="n">pixels</span><span class="o">=</span><span class="n">pixels</span><span class="p">,</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">obs_time</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time spent on a single CPU:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;seconds&quot;</span><span class="p">)</span>
<span class="c1"># &gt; Time spent on a single CPU: 35.23 seconds</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">emission_parallel</span> <span class="o">=</span> <span class="n">model_parallel</span><span class="o">.</span><span class="n">get_binned_emission_pix</span><span class="p">(</span>
    <span class="mi">40</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span>
    <span class="n">pixels</span><span class="o">=</span><span class="n">pixels</span><span class="p">,</span>
    <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
    <span class="n">obs_time</span><span class="o">=</span><span class="n">obs_time</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Time spent on </span><span class="si">{</span><span class="n">n_proc</span><span class="si">}</span><span class="s2"> CPUs:&quot;</span><span class="p">,</span>
    <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;seconds&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># &gt; Time spent on 8 CPUs: 12.85 seconds</span>

<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">emission</span><span class="p">,</span> <span class="n">emission_parallel</span><span class="p">)</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Windows users</p>
<p>Windows users must make sure to wrap the <code>get_*_emission_*</code> function calls in a <code>if __name__ == "__main__"</code> guard to avoid spawning infinite processes: 
<div class="highlight"><pre><span></span><code><span class="o">...</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">emission</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_emission_pix</span><span class="p">(</span>
        <span class="o">...</span>
    <span class="p">)</span>
</code></pre></div></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Using ZodiPy in parallelized environments</p>
<p>If ZodiPy is used in a parallelized environment one may have to specifically set the environment variable 
<code>OMP_NUM_THREADS=1</code> to avoid oversubscription. This is due automatic parallelization in third party libraries such as <code>healpy</code> where for instance the <code>hp.Rotator</code> object automatically parallelizes rotation of unit vectors.
This means that when using ZodiPy with pointing in a coordinate system other than ecliptic, even if <code>Zodipy</code> is initialized with <code>n_proc</code>=1, <code>healpy</code> will under the hood automatically distribute the pointing to available CPU's.</p>
</div>
<h2 id="visualizing-the-interplanetary-dust-distribution-of-a-model">Visualizing the interplanetary dust distribution of a model</h2>
<p>It is possible to visualize the three-dimensional interplanetary dust distribution of the models used in
ZodiPy by using the <code>tabulate_density</code> function which takes in a interplanetary dust model and a custom grid.</p>
<p>In the following example we tabulate the density distribution of the DIRBE interplanetary dust model
and plot the cross section of the diffuse cloud components density in the yz-plane.</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="kn">from</span> <span class="nn">zodipy</span> <span class="kn">import</span> <span class="n">tabulate_density</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># x-plane</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># y-plane</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># z-plane</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
<span class="n">density_grid</span> <span class="o">=</span> <span class="n">tabulate_density</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;dirbe&quot;</span><span class="p">)</span>
<span class="n">density_grid</span> <span class="o">=</span> <span class="n">density_grid</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Sum over all components</span>

<span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">density_grid</span><span class="p">[</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>  <span class="c1"># cross section in the yz-plane</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;afmhot&quot;</span><span class="p">,</span>
    <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">density_grid</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">density_grid</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
    <span class="n">shading</span><span class="o">=</span><span class="s2">&quot;gouraud&quot;</span><span class="p">,</span>
    <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cross section of the interplanetary dust density (yz-plane)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [AU]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;z [AU]&quot;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&quot;../img/density_grid.png&quot;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<img alt="Interplanetary dust distribution" src="../img/density_grid.png" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>